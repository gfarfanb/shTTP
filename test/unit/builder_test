#! /usr/bin/env bash
#  Tests for 'http_api' builder functions.
#  -author Giovanni FarfÃ¡n B.


#  -test Set URL
url "https://any.host/any/endpoint"
#  shellcheck disable=SC2154
assertEquals "Set URL does not work" "https://any.host/any/endpoint" "$_shttp_url"
_init_vars


#  -test Set protocol
protocol ftp
#  shellcheck disable=SC2154
assertEquals "Set protocol does not work" "ftp" "$_shttp_protocol"
_init_vars


#  -test Set domain
domain "0.0.0.0:0000"
#  shellcheck disable=SC2154
assertEquals "Set domain does not work" "0.0.0.0:0000" "$_shttp_domain"
_init_vars


#  -test Set endpoint
basePath "api/path"
#  shellcheck disable=SC2154
assertEquals "Set base path does not work" "api/path" "$_shttp_base_path"
_init_vars


#  -test Set endpoint
endpoint "id/test"
#  shellcheck disable=SC2154
assertEquals "Set endpoint does not work" "id/test" "$_shttp_endpoint"
_init_vars


#  -test Set method
method "GET"
#  shellcheck disable=SC2154
assertEquals "Method 'GET' not found" "GET" "$_shttp_method"

method "POST"
#  shellcheck disable=SC2154
assertEquals "Method 'POST' not found" "POST" "$_shttp_method"

method "PUT"
#  shellcheck disable=SC2154
assertEquals "Method 'PUT' not found" "PUT" "$_shttp_method"

method "PATCH"
#  shellcheck disable=SC2154
assertEquals "Method 'PATCH' not found" "PATCH" "$_shttp_method"

method "DELETE"
#  shellcheck disable=SC2154
assertEquals "Method 'DELETE' not found" "DELETE" "$_shttp_method"

method "HEAD"
#  shellcheck disable=SC2154
assertEquals "Method 'HEAD' not found" "HEAD" "$_shttp_method"

method "OPTIONS"
#  shellcheck disable=SC2154
assertEquals "Method 'OPTIONS' not found" "OPTIONS" "$_shttp_method"

_init_vars


#  -test Set headers
headers "Header-1: test/1" "Header-2: test/2" "Header-3: test/3"
#  shellcheck disable=SC2154
_length=${#_shttp_headers[@]}
assertEquals "Set headers does not work" 3 "$_length"
_init_vars


#  -test Set body
body '{' '"key": "value"' ',' '"name": "test"' '}'
#  shellcheck disable=SC2154
_length=${#_shttp_body[@]}
assertEquals "Set body does not work" 5 "$_length"
_init_vars

body 0 '5t' 'Lorem ipsum'
_content="${_shttp_body[*]}"
_length=${#_content}
assertEquals "Set body does not work" 59 "$_length"
_init_vars

body 0 '110s' 'Lorem ipsum'
_content="${_shttp_body[*]}"
_length=${#_content}
assertTrue "Set body does not work" "$_length -ge 110"
_init_vars


#  -test Set form
form "key=value" "name=test"
#  shellcheck disable=SC2154
_length=${#_shttp_form[@]}
assertEquals "Set form does not work" 2 "$_length"
_init_vars


#  -test Set query parameters
queryParams "key=value" "name=test"
#  shellcheck disable=SC2154
_length=${#_shttp_query_params[@]}
assertEquals "Set query parameters does not work" 2 "$_length"
_init_vars


#  -test Set cURL options
curlOpts "--basic" "-u user:password"
#  shellcheck disable=SC2154
_length=${#_shttp_curl_opts[@]}
assertEquals "Set cURL options does not work" 2 "$_length"
_init_vars


#  -test Set authorization mode
authMode "BASIC"
#  shellcheck disable=SC2154
assertEquals "'BASIC' mode not found" "BASIC" "$_shttp_auth_mode"

authMode "HEADER"
#  shellcheck disable=SC2154
assertEquals "'HEADER' mode not found" "HEADER" "$_shttp_auth_mode"

authMode "QPARAM"
#  shellcheck disable=SC2154
assertEquals "'QPARAM' mode not found" "QPARAM" "$_shttp_auth_mode"

authMode "SKIP"
#  shellcheck disable=SC2154
assertEquals "'SKIP' mode not found" "SKIP" "$_shttp_auth_mode"

_init_vars


#  -test Set authentication credential
credential 'user'
#  shellcheck disable=SC2154
assertEquals "Set credential does not work" "user" "$_shttp_auth_credential"
_init_vars


#  -test Set request execution times
times 5
#  shellcheck disable=SC2154
assertEquals "Set request times does not work" 5 "$_shttp_request_times"
_shttp_request_times=0


#  -test Set editor command
editor 'vim script'
#  shellcheck disable=SC2154
assertEquals "Set editor command does not work" "vim script" "$_shttp_editor_command"
_init_vars


#  -test Set output
output 'output/response'
#  shellcheck disable=SC2154
assertEquals "Set output does not work" "output/response" "$_shttp_output"
_init_vars


#  -test Set environment
echo '{ }' > ws/config.test.json
echo '[ ]' > ws/credentials.test.json

env "test"

#  shellcheck disable=SC2154
assertEquals "Configuration 'test' not found" "ws/config.test.json" "$_shttp_env"
#  shellcheck disable=SC2154
assertEquals "Credentials 'test' not found" "ws/credentials.test.json" "$_shttp_creds"

env
rm -f ws/config.test.json
rm -f ws/credentials.test.json


#  -test Set options
_shttp_input_params=""
mainOpts --set a a --set b b
_input_parameters=( $(echo "$_shttp_input_params" | tr " " "\n") )
_input_length=${#_input_parameters[@]}
assertEquals "Main options not set" 6 "$_input_length"

_shttp_input_params="get_all --auth-header test"
mainOpts --set a a --set b b
_input_parameters=( $(echo "$_shttp_input_params" | tr " " "\n") )
_input_length=${#_input_parameters[@]}
assertEquals "Main options set" 3 "$_input_length"

_shttp_input_params=""
